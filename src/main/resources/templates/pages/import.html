<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: base(~{::pageTitle}, ~{::content})}">

<head>
    <title th:fragment="pageTitle">Import - Finance Tracker</title>
</head>

<body>
    <th:block th:fragment="content">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 dark:text-slate-50">
            Import from CSV
        </h1>

        <form th:action="@{/import/}" method="post" enctype="multipart/form-data" id="upload-form"
            th:object="${importCSVForm}">
            <p class="text-gray-600 mb-6 dark:text-slate-300">
                Please select your CSV format
            </p>

            <select th:field="*{formatOptionId}"
                class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 pr-10 text-sm shadow-sm
               focus:outline-none mb-5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500
               dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100 dark:focus:ring-blue-500 dark:focus:border-blue-500" name="format-selector"
                id="format-selector">
                <option th:each="item : ${formatOptions}" th:text="${item.name}" th:value="${item.formatId}">
                </option>
            </select>

            <!-- hidden file input -->
            <input type="file" th:field="*{file}" id="file-input" name="file" accept=".csv" class="hidden" />

            <!-- drop zone -->
            <div id="dropzone" class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer
                  bg-gray-50 hover:bg-gray-100 transition-colors
                  dark:bg-slate-900 dark:border-slate-700 dark:hover:bg-slate-800">

                <p class="text-sm text-gray-600 dark:text-slate-300">
                    <span class="font-semibold">Drag & drop</span> your CSV file here
                    or <span class="text-blue-600 underline dark:text-blue-400">click to browse</span>
                </p>
                <p id="file-name" class="mt-2 text-xs text-gray-500 dark:text-slate-400">
                    No file selected
                </p>
            </div>

            <button type="submit" class="mt-4 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700
               disabled:bg-gray-300 disabled:cursor-not-allowed
               dark:disabled:bg-slate-600" id="submit-btn" disabled>
                Upload CSV
            </button>
        </form>



        <!-- TABLE PREVIEW -->
        <div class="mt-8" th:if="${transactions != null}">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 dark:text-slate-50">
                Filters
            </h2>

            <th:block th:insert="~{fragments/filter-fragment :: transactionsFilter(@{/import/filter})}" />

            <h2 class="text-2xl font-semibold text-gray-800 mb-4 dark:text-slate-50">
                Insights
            </h2>

            <div class="border-t border-gray-200 dark:border-gray-700">
                <th:block th:insert="~{fragments/insight-summary-fragment :: summaryFragment}" />
            </div>

            <!-- BENTO INSIGHT -->

            <div class="border-b border-gray-200 dark:border-gray-700">
                <th:block th:if="${transactions != null}">
                    <th:block th:insert="~{fragments/insights/insight-bento-fragment :: insight(${transactions})}">
                    </th:block>
                </th:block>
                <br>

                <div class="flex justify-end mb-4">
                    <form id="exportReportForm"
                          th:action="@{/import/export-pdf}"
                          th:object="${insightExportPDFForm}"
                          method="post">

                        <input type="hidden" th:field="*{filterForm.startDate}" />
                        <input type="hidden" th:field="*{filterForm.endDate}" />

                        <!-- Include filters -->
                        <input type="hidden" th:field="*{filterForm.categories}" />
                        <input type="hidden" th:field="*{filterForm.subCategories}" />
                        <input type="hidden" th:field="*{filterForm.types}" />
                        <input type="hidden" th:field="*{filterForm.noteKeywords}" />

                        <!-- Exclude filters -->
                        <input type="hidden" th:field="*{filterForm.excludeCategories}" />
                        <input type="hidden" th:field="*{filterForm.excludeSubCategories}" />
                        <input type="hidden" th:field="*{filterForm.excludeTypes}" />
                        <input type="hidden" th:field="*{filterForm.excludeNoteKeywords}" />

                        <!-- base64 images -->
                        <input type="hidden" id="heatmapImageBase64" name="heatmapImageBase64" th:field="*{heatmapImageBase64}" />
                        <input type="hidden" id="categoryChartImageBase64" name="categoryChartImageBase64" th:field="*{categoryChartImageBase64}"  />
                        <input type="hidden" id="trendChartImageBase64" name="trendChartImageBase64" th:field="*{trendChartImageBase64}"/>

                        <button
                                id="exportPdfBtn"
                                type="button"
                                class="rounded-lg bg-green-600 dark:bg-green-600 px-5 py-2 text-white text-sm font-medium shadow-md
                   hover:bg-blue-700 dark:hover:bg-blue-600 transition">
                            Export as PDF
                        </button>
                    </form>
                </div>

            </div>
            
            <h2 class="text-2xl font-semibold text-gray-800 mt-4 mb-4 dark:text-slate-50">
                All Transactions
            </h2>

            <th:block th:insert="~{fragments/table-fragment :: rowsOnly(${transactions})}" />

        </div>


        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
                integrity="sha512-BNa5lHfZfQOQ4rA6Ymc5T4rZt4WeD0c2UyrKvW3WNg3unEjn8r4n4t04nTaC9QJQz3lga8Qv0I9MbugwZsmQ3g=="
                crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

        <!-- DataTables CSS -->
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" />

        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

        <!-- DataTables JS -->
        <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

        <script th:src="@{/js/pages/importCSV/table-dropzone.js}"></script>
        <script th:src="@{/js/pages/importCSV/multi-select.js}"></script>

    </th:block>
</body>

</html>